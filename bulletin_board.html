<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AETERNUM // BBS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(20, 20, 25, 0.9); --accent: #66fcf1; --void: #050505; }
        body { background-color: var(--void); color: #e0e7ff; font-family: 'Space Mono', monospace; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(165, 180, 252, 0.15); }
        
        /* Tab Styling */
        .tab-btn { padding: 10px 20px; border-bottom: 2px solid transparent; color: #64748b; transition: 0.3s; cursor: pointer; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); background: rgba(102, 252, 241, 0.05); }

        /* Message Cards */
        .msg-card { border-left: 2px solid #334155; padding: 1rem; margin-bottom: 1rem; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .msg-card:hover { border-left-color: var(--accent); background: rgba(255,255,255,0.03); }

        /* Lit Card (Written Works) */
        .lit-card { border: 1px solid #334155; padding: 1.5rem; margin-bottom: 1.5rem; background: rgba(0,0,0,0.4); }
        .lit-card h3 { font-family: serif; font-size: 1.2rem; color: #a5b4fc; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="min-h-screen p-4 lg:p-8 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-fixed">

    <div class="max-w-5xl mx-auto glass-panel rounded-xl min-h-[90vh] flex flex-col relative overflow-hidden">
        
        <header class="border-b border-white/10 bg-black/40">
            <div class="p-6 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-[#66fcf1] tracking-widest">BULLETIN_BOARD</h1>
                    <p class="text-[10px] text-gray-500">PUBLIC NODE // <span id="user-status">CONNECTING...</span></p>
                </div>
                <a href="dashboard.html" class="text-xs text-gray-400 hover:text-white">< RETURN</a>
            </div>
            
            <div class="flex text-sm font-bold border-t border-white/5">
                <button onclick="switchTab('chat')" id="tab-chat" class="tab-btn active flex-1">/// COMM_LINK</button>
                <button onclick="switchTab('lit')" id="tab-lit" class="tab-btn flex-1">/// LITERATURE</button>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-6 relative">
            
            <div id="view-chat" class="space-y-4">
                <div class="text-center text-xs text-gray-600 italic">Connecting to Comm Stream...</div>
            </div>

            <div id="view-lit" class="hidden space-y-6">
                <div class="text-center text-xs text-gray-600 italic">Accessing Archives...</div>
            </div>

        </div>

        <div class="p-4 border-t border-white/10 bg-black/60 relative z-20">
            
            <div id="error-log" class="text-[10px] text-red-400 mb-2 hidden"></div>

            <div id="input-chat" class="flex gap-4">
                <div class="text-xs text-[#66fcf1] pt-3 font-bold display-user">USER:</div>
                <textarea id="chat-msg" rows="1" class="flex-1 bg-transparent border border-gray-700 rounded p-2 text-sm focus:border-[#66fcf1] focus:outline-none resize-none" placeholder="Broadcast a signal..."></textarea>
                <button onclick="sendPost('chat')" class="bg-[#66fcf1]/10 text-[#66fcf1] border border-[#66fcf1] px-6 rounded hover:bg-[#66fcf1] hover:text-black font-bold text-xs transition">SEND</button>
            </div>

            <div id="input-lit" class="hidden flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-purple-400 font-bold uppercase">New Entry</span>
                    <span class="text-[10px] text-gray-500 display-user">USER</span>
                </div>
                <input id="lit-title" type="text" class="w-full bg-transparent border border-gray-700 rounded p-2 text-sm font-bold text-white focus:border-purple-500 focus:outline-none" placeholder="Title of Work...">
                <textarea id="lit-body" rows="6" class="w-full bg-transparent border border-gray-700 rounded p-2 text-sm focus:border-purple-500 focus:outline-none" placeholder="Write your story, poem, or log here..."></textarea>
                <div class="flex justify-end">
                    <button onclick="sendPost('lit')" class="bg-purple-900/30 text-purple-300 border border-purple-500 px-8 py-2 rounded hover:bg-purple-500 hover:text-white font-bold text-xs transition">PUBLISH TO ARCHIVE</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db, auth, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, onAuthStateChanged, doc, getDoc } from './firebase-config.js';

        // State
        let currentUser = null;
        let currentHandle = "UNKNOWN";
        let currentTab = 'chat';

        // 1. AUTH CHECK (Wait for Firebase to confirm who we are)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Fetch the handle we saved during login
                const userSnap = await getDoc(doc(db, "users", user.uid));
                if (userSnap.exists()) {
                    currentHandle = userSnap.data().handle;
                    document.querySelectorAll('.display-user').forEach(el => el.innerText = currentHandle);
                    document.getElementById('user-status').innerText = "CONNECTED::" + currentHandle;
                }
            } else {
                // Not logged in? Send back to start.
                window.location.href = "index.html";
            }
        });

        // --- TABS & UI LOGIC (Same as before) ---
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tab-chat').classList.toggle('active', tab === 'chat');
            document.getElementById('tab-lit').classList.toggle('active', tab === 'lit');
            document.getElementById('view-chat').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('view-lit').classList.toggle('hidden', tab !== 'lit');
            document.getElementById('input-chat').classList.toggle('hidden', tab !== 'lit'); 
            document.getElementById('input-chat').style.display = tab === 'chat' ? 'flex' : 'none';
            document.getElementById('input-lit').classList.toggle('hidden', tab !== 'lit');
            const area = document.getElementById('content-area');
            area.scrollTop = area.scrollHeight;
        }

        // --- POSTING LOGIC ---
        window.sendPost = async function(type) {
            const errorLog = document.getElementById('error-log');
            errorLog.classList.add('hidden');
            
            if (!currentUser) return alert("CONNECTION LOST. PLEASE RELOG.");

            try {
                if (type === 'chat') {
                    const field = document.getElementById('chat-msg');
                    const text = field.value.trim();
                    if (!text) return;
                    
                    await addDoc(collection(db, "posts"), {
                        type: "chat",
                        uid: currentUser.uid, // Store secure ID
                        user: currentHandle,  // Store display name
                        text: text,
                        timestamp: serverTimestamp()
                    });
                    field.value = ""; 
                } 
                else if (type === 'lit') {
                    const titleField = document.getElementById('lit-title');
                    const bodyField = document.getElementById('lit-body');
                    const title = titleField.value.trim();
                    const body = bodyField.value.trim();
                    if (!title || !body) return alert("Title and Body required.");

                    await addDoc(collection(db, "posts"), {
                        type: "lit",
                        uid: currentUser.uid,
                        user: currentHandle,
                        title: title,
                        text: body,
                        timestamp: serverTimestamp()
                    });
                    titleField.value = "";
                    bodyField.value = "";
                    alert("Work Archived.");
                }
            } catch (e) {
                console.error("Firebase Error:", e);
                errorLog.innerText = "ERROR: " + e.message;
                errorLog.classList.remove('hidden');
            }
        }

        // --- LISTENERS ---
        const chatQ = query(collection(db, "posts"), where("type", "==", "chat"), orderBy("timestamp", "asc"));
        onSnapshot(chatQ, (snapshot) => {
            const view = document.getElementById('view-chat');
            view.innerHTML = `<div class="text-center text-[10px] text-gray-700 mb-4">--- ENCRYPTED STREAM ACTIVE ---</div>`;
            snapshot.forEach(doc => {
                const d = doc.data();
                const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "..";
                view.innerHTML += `
                    <div class="msg-card py-2">
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="text-xs font-bold text-[#66fcf1]">${escape(d.user)}</span>
                            <span class="text-[10px] text-gray-600">${time}</span>
                        </div>
                        <p class="text-sm text-gray-300 whitespace-pre-wrap">${escape(d.text)}</p>
                    </div>`;
            });
            if(currentTab === 'chat') document.getElementById('content-area').scrollTop = document.getElementById('content-area').scrollHeight;
        });

        const litQ = query(collection(db, "posts"), where("type", "==", "lit"), orderBy("timestamp", "desc"));
        onSnapshot(litQ, (snapshot) => {
            const view = document.getElementById('view-lit');
            view.innerHTML = "";
            if (snapshot.empty) view.innerHTML = `<div class="text-center text-gray-500 italic mt-10">Archives empty.</div>`;
            snapshot.forEach(doc => {
                const d = doc.data();
                const date = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleDateString() : "Pending";
                view.innerHTML += `
                    <div class="lit-card rounded bg-black/40 hover:bg-black/60 transition">
                        <div class="flex justify-between items-start border-b border-gray-800 pb-2 mb-3">
                            <div>
                                <h3 class="font-bold text-lg text-purple-300">${escape(d.title)}</h3>
                                <div class="text-[10px] text-gray-500 uppercase">Author: <span class="text-gray-300">${escape(d.user)}</span></div>
                            </div>
                            <span class="text-[10px] border border-gray-800 px-2 py-1 rounded text-gray-600">${date}</span>
                        </div>
                        <div class="text-sm text-gray-300 leading-relaxed font-serif whitespace-pre-wrap">${escape(d.text)}</div>
                    </div>`;
            });
        });

        function escape(s) { if(!s) return ""; return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
    </script>
</body>
</html>